<!DOCTYPE html>
<html lang="zh" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light" />
  <link rel="stylesheet" href="./static/bulma.min.css" />
  <!-- <link rel="stylesheet" href="./static/font-awesome.css" /> -->
  <!-- <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.2/css/all.min.css"> -->
  <style>
    .help-cell {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .layout-container {
      display: flex;
      height: calc(100% - 60px);
      margin-top: 20px;
    }

    .sidebar {
      width: 200px;
      border-right: 1px solid #eee;
      overflow-y: auto;
      padding: 1rem;
      background: #fafafa;
    }

    .main-content {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      height: 100%;
    }

    .group-title {
      cursor: pointer;
      font-weight: bold;
      margin: 0.5em 0 0.2em 0;
      display: flex;
      align-items: center;
    }

    .group-title .icon {
      margin-right: 0.6em;
      transition: transform 0.2s;
    }

    .group-title.collapsed .icon {
      transform: rotate(-90deg);
    }

    .list-item {
      margin-left: 1.8em;
      cursor: pointer;
      padding: 0.1em 0.3em;
      border-radius: 3px;
      margin-bottom: 2px;
    }

    .list-item.selected,
    .group-title.selected {
      background: #e6f0fa;
      color: #3273dc;
    }

    .table .editable-cell {
      cursor: pointer;
      background: #f8f8fd;
      min-width: 120px;
      max-width: 120px;
      width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .table .editable-cell input {
      width: 100%;
      box-sizing: border-box;
    }

    .table th.col3,
    .table td.col3 {
      width: 120px;
      min-width: 120px;
      max-width: 120px;
      text-align: left;
    }

    .my-div {
      width: 200px;
      text-wrap: nowrap;
      overflow: hidden;
    }

    .messages {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 10px;
    }

    table {
      font-size: 16px;
    }

    .my-field {
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: flex-start;
      padding: 10px;
    }
  </style>
  <script src="/static/jszip.min.js"></script>
  <script src="/static/clusterize.min.js"></script>
  <script src="/static/pip-video.js"></script>
</head>

<body style="padding: 10px">
  <div style="
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        flex-direction: row;
        flex-wrap: wrap;
      ">
    <button class="button" onclick="socketHelper.cmd()">地面站命令</button>
    <button class="button" onclick="setMode('RTL')">
      返航
    </button>
    <button class="button" onclick="_return()">返航(可加航点)</button>
    <button class="button" onclick="setMode('LAND')">
      降落
    </button>
    <button class="button" onclick="land()">降落(可加航点)</button>
    <button class="button" onclick="setMode('LOITER')">
      悬停
    </button>
    <button class="button" onclick="setMode('GUIDED')">
      guided
    </button>
    <button class="button" onclick="setMode('AUTO')">
      auto
    </button>
    <button class="button" onclick="arm()">
      解锁
    </button>
    <button class="button" onclick="socketHelper.createFunc('wp list')">
      下载航点
    </button>
    <button class="button" onclick="takeoff()">起飞</button>
    <button class="button" onclick="prearm()">起飞检查</button>
    <button class="button" onclick="wpSet()">设置航点</button>
    <button class="button" onclick="getGPS()">获取GPS</button>
    <button class="button" onclick="getGPSv2()">获取GPSv2</button>
    <button class="button" onclick="carCrash('bucket')">小车打击</button>
    <button class="button" onclick="droneCrash()">飞机打击</button>
    <button class="button" onclick="stopCrash()">停止打击</button>
    <button class="button" onclick="stopFollow()">停止跟随</button>
    <button class="button" onclick="testCar()" id="test-button">
      小车测试
    </button>
    <button class="button" id="record" onclick="recordHelper.click()">
      开始录像
    </button>
    <button class="button" id="detect" onclick="detectHelper.start()">
      开始检测
    </button>
    <button class="button" id="detect" onclick="detectHelper.stop()">
      停止检测
    </button>
    <button class="button" onclick="dataHelper.click()" id="start-button">
      开始采集数据
    </button>
    <button class="button" onclick="setGimbal()">设置云台</button>
    <button class="button" onclick="setParams()">设置参数</button>

    <button class="button" onclick="downloadLogs()">下载日志</button>
    <button class="button" onclick="rtcHelper.start()">开始拉流</button>
  </div>
  <div class="notification is-danger is-light" id="popup" style="display: none; margin: 10px"></div>
  <div id="messages2" class="messages" style="margin-top: 20px; font-size: 20px"></div>
  <div id="messages" class="messages" style="margin-top: 5px"></div>
  <div style="width: 100%; overflow: auto;">
    <table style="margin-top: 10px;" id="jsonTable"
      class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth"></table>
  </div>


  <div class="modal" id="tableDialog">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 1000px">
      <header class="modal-card-head">
        <p class="modal-card-title">设置参数</p>
      </header>
      <section class="modal-card-body" style="width: 100%; padding: 10px">
        <section class="section" style="height: 100%; padding: 10px">
          <div class="container" style="height: 100%">
            <div class="field">
              <div class="control has-icons-left">
                <input id="searchInput" class="input" type="text" placeholder="搜索..." />
                <span class="icon is-left">
                  <svg style="transform: scale(0.7)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                    <!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                    <path
                      d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376C296.3 401.1 253.9 416 208 416 93.1 416 0 322.9 0 208S93.1 0 208 0 416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z" />
                  </svg>
                </span>
              </div>
            </div>
            <div class="layout-container">
              <aside class="sidebar" id="sidebar"></aside>
              <main class="main-content">
                <div id="scrollArea" class="clusterize-scroll">
                  <table class="table is-fullwidth is-hoverable is-striped">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Help</th>
                        <th>Default</th>
                        <th class="col3">Value</th>
                      </tr>
                    </thead>
                    <tbody id="contentArea" class="clusterize-content">
                      <tr class="clusterize-no-data">
                        <td>Loading data…</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </main>
            </div>
          </div>
        </section>
      </section>
      <footer class="modal-card-foot">
        <div class="buttons" style="margin-left: auto">
          <button class="button is-success" id="tableConfirmBtn">OK</button>
          <button class="button is-danger" id="tableCancelBtn">Cancel</button>
        </div>
      </footer>
    </div>
  </div>

  <div class="modal" id="myDialog">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">设置云台</p>
      </header>
      <section class="modal-card-body">
        <div class="my-field">
          <label class="label is-large"> Mode: </label>
          <div class="select">
            <select id="mode" class="is-large">
              <option value="abs">绝对</option>
              <option value="res">相对</option>
            </select>
          </div>
        </div>
        <div class="my-field">
          <label class="label is-large"> Angle: </label>
          <div class="control">
            <div class="select">
              <select id="angle" class="is-large">
                <option value="0">0</option>
                <option value="20">-20</option>
                <option value="45">-45</option>
                <option value="60">-60</option>
                <option value="90">-90</option>
              </select>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <div class="buttons">
          <button class="button is-success" id="confirmBtn">OK</button>
        </div>
      </footer>
    </div>
  </div>
</body>
<script>
  document.title = location.hostname
  var url = window.location.host;
  var roi = ["mode", "arm", "gps_fix_type", "gps_nsats", "rel_alt"];
  const handleRes = (res) => {
    let data;
    if (res["detail"] != undefined) {
      data = res["detail"]
    }
    else {
      data = res["msg"]
    }
    if (typeof data == "string") {
      alert(data)
    } else {
      alert(JSON.stringify(data))
    }
  }
  // let tableData = {"data":[{"num":0,"command":16,"param1":0,"param2":0,"param3":0,"param4":0,"lat":30.112289099999998,"lon":120.14325849999999,"alt":32.369998931884766,"frame":0},{"num":1,"command":22,"param1":0,"param2":0,"param3":0,"param4":0,"lat":30.1122572,"lon":120.1426542,"alt":7,"frame":3},{"num":2,"command":16,"param1":5,"param2":0,"param3":0,"param4":0,"lat":30.112246,"lon":120.1434901,"alt":6,"frame":3},{"num":3,"command":178,"param1":1,"param2":3,"param3":-1,"param4":0,"lat":0,"lon":0,"alt":0,"frame":0},{"num":4,"command":16,"param1":3,"param2":0,"param3":0,"param4":0,"lat":30.112133399999998,"lon":120.143491,"alt":6,"frame":3},{"num":5,"command":16,"param1":0,"param2":0,"param3":0,"param4":0,"lat":30.1120332,"lon":120.14349689999999,"alt":6,"frame":3},{"num":6,"command":16,"param1":0,"param2":0,"param3":0,"param4":0,"lat":30.112038199999997,"lon":120.1433948,"alt":6,"frame":3},{"num":7,"command":16,"param1":0,"param2":0,"param3":0,"param4":0,"lat":30.1121132,"lon":120.1433655,"alt":5,"frame":3}],"total":8}
  // generateTable(tableData["data"])
  // Function to generate table from JSON

  class DataHelper {
    constructor() {
      this.snapshotStorage = {};
      this.gpsDataStorage = {};
      this.currentId = 0;
      this.cameraId = 0;
      this.running = false;
      this.record_timer = null;
    }

    async start() {
      let input = prompt("camera id");
      if (input == null) return;
      this.cameraId = input;
      this.running = true;
      this.snapshotStorage = {};
      this.gpsDataStorage = {};
      this.currentId = 0;
      document.querySelector("#start-button").textContent = "初始化中...";
      let img = document.createElement("img");
      img.id = "img2";
      document.body.appendChild(img);
      await this.snap();
      this.record_timer = setInterval(async () => {
        await this.snap();
      }, 1000);
    }

    async stop() {
      if (this.record_timer) {
        clearInterval(this.record_timer);
        this.record_timer = null;
      }
      // let video = document.querySelector("video-stream");
      // if (video) video.remove();
      this.running = false;
      await this.download();
      document.querySelector("#start-button").textContent = "开始采集数据";
      let img = document.querySelector("#img2");
      img && img.remove();
      // document.querySelector("#counter").innerHTML = "";
    }

    async click() {
      this.running ? this.stop() : this.start();
    }

    async snap() {
      try {
        // 获取快照
        const snapshotResponse = await fetch(
          `http://${url}/snapshot/${this.cameraId}`
        );
        const snapshotBlob = await snapshotResponse.blob();
        const imgUrl = URL.createObjectURL(snapshotBlob);
        let img = document.querySelector("#img2");
        img.src = imgUrl;

        // 注意：不再需要时释放内存
        img.onload = function () {
          URL.revokeObjectURL(imgUrl);
        };
        // 存储快照
        this.snapshotStorage[this.currentId] = snapshotBlob;

        // 获取GPS数据
        const [gpsData, attitudeData] = await Promise.all([
          fetch(`http://${url}/get_gps`).then((res) => res.json()),
          fetch(`http://${url}/get_attitude`).then((res) => res.json()),
        ]);

        // 存储GPS数据
        if (gpsData["status"] == "success") {
          this.gpsDataStorage[this.currentId] = {
            gps: gpsData["msg"],
            ...attitudeData["msg"],
          };
        } else {
          alert("gps 数据获取失败");
          delete this.snapshotStorage[this.currentId];
          return;
        }

        if (!this.running) return; // 由于取数据, 现在才结束
        this.currentId += 1; // 自增ID
        document.querySelector(
          "#start-button"
        ).textContent = `停止(已采集: ${this.currentId})`;
      } catch (error) {
        console.error("Error:", error);
      }
    }

    async download() {
      try {
        const zip = new JSZip();

        // 添加图片到ZIP文件
        Object.entries(this.snapshotStorage).forEach(async ([id, url]) => {
          zip.file(`${id}.jpg`, url, { binary: true });
        });

        // 添加GPS数据到ZIP文件
        const gpsJson = JSON.stringify(this.gpsDataStorage);
        zip.file("gps_data.json", gpsJson);

        // 生成ZIP并触发下载
        zip.generateAsync({ type: "blob" }).then(function (content) {
          const zipUrl = URL.createObjectURL(content);
          const a = document.createElement("a");
          a.href = zipUrl;
          a.download = "data.zip";
          a.click();
          URL.revokeObjectURL(zipUrl);
        });
      } catch (error) {
        console.error("Error:", error);
      }
    }
  }

  class RecordHelper {
    constructor() {
      this.running = false;
    }

    async start() {
      return fetch(`/start_record`)
        .then((res) => res.json())
        .then((resJSON) => {
          this.running = true;
          document.getElementById("record").innerText = "结束录像";
          console.log(resJSON);
        });
    }

    async stop() {
      fetch(`/stop_record`)
        .then((res) => res.json())
        .then((resJSON) => {
          this.running = false;
          console.log(resJSON);
          document.getElementById("record").innerText = "开始录像";
        });
    }

    click() {
      this.running ? this.stop() : this.start();
    }
  }

  class SocketHelper {
    constructor() {
      this.socket = null;
      this.curState = {};
      this._onclose = null;
      this.last_data = null;
    }

    onclose(func) {
      this._onclose = func;
    }

    static generateTable(data) {
      if (data.length == 0) return;
      data = data.sort((a, b) => a.num > b.num);
      const table = document.getElementById("jsonTable");
      while (table.rows.length > 0) {
        table.deleteRow(0);
      }
      // Create the table header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      const headers = Object.keys(data[0]);
      for (const header of headers) {
        const th = document.createElement("th");
        th.textContent = header.charAt(0).toUpperCase() + header.slice(1);
        headerRow.appendChild(th);
      }

      // Create the table body
      const tbody = document.createElement("tbody");
      table.appendChild(tbody);

      for (const item of data) {
        const row = tbody.insertRow();
        for (const key of headers) {
          const cell = row.insertCell();
          if (key == "lon" || key == "lat") {
            cell.textContent = item[key].toFixed(7);
          } else {
            cell.textContent = item[key];
          }
        }
      }
    }

    connect() {
      //ws://192.168.1.99:8000/ws
      if (this.socket != null && this.socket.readyState === WebSocket.OPEN) {
        return;
      }
      this.socket = new WebSocket(`ws://${url}/ws`);
      this.curState = {};
      this.socket.onopen = () => {
        console.log("WebSocket 连接已建立");
        this.socket.send("wp list");
      };

      this.socket.onmessage = function (event) {
        if (event.data != "{}") {
          let newData = JSON.parse(event.data);
          if (newData["type"] == "state") {
            this.curState = { ...this.curState, ...newData };
          } else if (newData["type"] == "error") {
            let err = newData["error"];
            showPopup(err, 3);
            console.log("error", err);
          } else if (newData["event"] == "detect") {
            let img = document.querySelector("#img");
            img && (img.src = newData["url"]);
            console.log("detect", event.data);
          } else if (newData["type"] == "event") {
            console.log(newData["event"], newData);
          }

          let table = this.curState["mission_data"];
          if (table) {
            SocketHelper.generateTable(this.curState["mission_data"]);
            delete this.curState["mission_data"];
          }
          // document.querySelector("#messages").innerHTML =
          //   JSON.stringify(curState);
          let container = document.querySelector("#messages");
          let container2 = document.querySelector("#messages2");
          let tofix = (data) => {
            if (typeof data == "number" && data % 1 != 0) {
              return data.toFixed(4);
            }
            return data;
          };
          let show = (key, value) => {
            if (roi.includes(key)) _show(container2, key, value);
            else _show(container, key, value);
          };
          let _show = (container, key, value) => {
            let dom = container.querySelector(`#${key}`);
            if (dom) {
              dom.innerHTML = `${key}: ${tofix(value)}`;
            } else {
              dom = document.createElement("div");
              dom.id = key;
              dom.className = "my-div";
              dom.innerHTML = `${key}: ${tofix(value)}`;
              container.appendChild(dom);
            }
          };
          const groupSort = (a, b) => {
            // 先比 group
            if (roi.includes(a) < roi.includes(b)) return 1;
            if (roi.includes(a) > roi.includes(b)) return -1;
            // group 相同，再比 name
            return a[0].localeCompare(b[0]);
          };
          Object.entries(this.curState)
            .sort((a, b) => groupSort(a[0], b[0]))
            .forEach(([key, value]) => {
              if (Array.isArray(value)) {
                value.forEach((v, i) => show(`${key}${i}`, v));
              } else show(key, value);
            });
        }
      };

      this.socket.onerror = function (error) {
        console.log("WebSocket 错误: ", error);
      };

      this.socket.onclose = function () {
        console.log("WebSocket 连接已关闭");
        console.log(document.querySelector("#messages").innerHTML)
        if (document.querySelector("#messages").innerHTML == "") return;
        document.querySelector("#messages").innerHTML = "";
        document.querySelector("#messages2").innerHTML = "";
        document.querySelector("#jsonTable").innerHTML = "";
        this._onclose && this._onclose();
        alert("websocket连接已关闭, 请检查网络连接, 确保mavproxy正常运行");
      };
    }

    cmd() {
      var _cmd = prompt("地面站命令:");
      if (_cmd.trim() == "") return
      this.socket && this.socket.send(_cmd);
    }

    send(_cmd) {
      this.socket && this.socket.send(_cmd);
    }

    createFunc(command, check = true) {
      if (check && !this.socket) {
        alert("未连接");
        return;
      }
      this.socket.send(command);
    }
  }

  class RTCHelper {
    constructor(url = "offer", onclose = null) {
      this.url = url;
      this.running = false;
      this.onclose = onclose;
    }

    async start() {
      const id_res = prompt("camera id and res(e.g. 0=640x480):");
      if (id_res == null) return;
      if (this.pc) {
        this.pc.close();
      }
      this.pc = new RTCPeerConnection();
      this.pc.addTransceiver('video', { direction: 'recvonly' }); // 只接收视频
      this.pc.ontrack = (event) => {
        const video = document.getElementById('pip-video');
        if (!video) return;
        video.srcObject = event.streams[0];
      };

      showPipVideo(null, () => this.stop())

      const offer = await this.pc.createOffer();
      await this.pc.setLocalDescription(offer);

      fetch(`/${this.url}/${id_res}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sdp: this.pc.localDescription.sdp,
          type: this.pc.localDescription.type
        })
      }).then(res => res.json()).then(async (answer) => {
        await this.pc.setRemoteDescription(answer);
        this.running = true;
      }, err => {
        alert(err)
        this.stop()
      });
    }

    stop() {
      this.running = false;
      this.pc && this.pc.close();
      this.onclose && this.onclose();
    }
  }

  // 辅助函数
  function showPopup(message, duration) {
    var popupElement = document.getElementById("popup");
    popupElement.textContent = message;
    popupElement.style.display = "block";
    // Automatically hide the popup after the specified duration
    setTimeout(function () {
      popupElement.textContent = "";
      popupElement.style.display = "none";
    }, duration * 1000);
  }

  let postJson = (url, data) => {
    const options = {
      method: "POST",
      headers: {
        "Content-Type": "application/json", // Specify the content type as JSON
      },
      body: JSON.stringify(data), // Convert the data object to a JSON string
    };
    return fetch(url, options);
  };

  let setMode = (mode) => {
    postJson(`http://${url}/set_mode`, { mode })
      .then(res => res.json())
      .then(handleRes, err => alert(err))
  }

  // 非socket 调用
  let getGPS = () => {
    fetch(`http://${url}/get_gps`)
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  };

  let getGPSv2 = () => {
    fetch(`http://${url}/get_gpsv2`)
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  };

  let takeoff = () => {
    let alt = prompt("起飞高度:")
    if (alt == null) return;
    alt = parseFloat(alt);
    if (isNaN(alt) || alt <= 0) {
      alert("请输入一个有效的高度");
      return;
    }
    console.log("takeoff");
    postJson(`http://${url}/takeoff`, { alt })
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  };

  let prearm = () => {
    fetch(`http://${url}/prearms`)
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  };

  let land = () => {
    let wp = window.prompt("waypoint list");
    if (wp == null) return;
    wp = wp.replace(/[^0-9\[\]\,\.]/g, "");
    postJson(`http://${url}/land`, { waypoint: JSON.parse(wp) })
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  };

  let testCar = () => {
    fetch(`http://${url}/test_car`)
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  };

  function _return() {
    let wp = window.prompt("waypoint list");
    if (wp == null) return;
    wp = wp.replace(/[^0-9\[\]\,\.]/g, "");
    postJson(`http://${url}/return`, { waypoint: JSON.parse(wp) })
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  }

  function wpSet() {
    let wp = window.prompt("waypoint list");
    if (wp == null) return;
    wp = wp.replace(/[^0-9\[\]\,\.-]/g, "");
    console.log("takeoff");
    postJson(`http://${url}/set_waypoint`, { waypoint: JSON.parse(wp) })
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  }

  let setGimbal = () => {
    let dialog = document.getElementById("myDialog");
    openModal(dialog);
    document.getElementById("confirmBtn").addEventListener("click", (e) => {
      e.preventDefault(); // 阻止表单默认提交
      // 你可以在这里获取下拉框选项的值并处理
      let mode = document.getElementById("mode").value;
      let angle = document.getElementById("angle").value;
      angle = parseInt(angle);
      postJson(`http://${url}/set_gimbal`, { mode, angle })
        .then((res) => res.json())
        .then(handleRes, err => alert(err))
        .finally(() => closeModal(dialog));
    });
  };

  let droneCrash = () => {
    postJson(`http://${url}/start_crash`, { type: 1, param: 2 })
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  };


  const carCrash = (target) => {
    return postJson(`/start_crash`, { target: [target] })
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  }

  const stopCrash = () => {
    fetch(`/stop_crash`)
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  }

    const stopFollow = () => {
    postJson(`/stop_follow`)
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  }

  const arm = () => {
    fetch(`/arm`, { method: "POST" })
      .then((res) => res.json())
      .then(handleRes, err => alert(err))
  }

  let downloadLogs = () => {
    // 创建一个隐藏的a标签
    var a = document.createElement("a");
    a.href = "/log"; // 你的下载接口
    a.download = "logs.zip"; // 建议的文件名（有些浏览器会忽略，后端Content-Disposition优先）
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  let dataHelper = new DataHelper();
  let recordHelper = new RecordHelper();
  let detectHelper = new RTCHelper("start_detect", () => {
    fetch(`http://${url}/stop_detect`)
      .then((res) => res.json())
      .then(handleRes, err => alert(err));
  });
  let socketHelper = new SocketHelper();
  let rtcHelper = new RTCHelper();

  socketHelper.onclose(() => {
    dataHelper.running && dataHelper.stop();
    socketHelper.running && socketHelper.stop();
    detectHelper.running && detectHelper.stop();
    rtcHelper.running && rtcHelper.stop();
  });
  socketHelper.connect();
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      socketHelper.connect();
    }
  });

  function openModal($el) {
    $el.classList.add("is-active");
  }

  function closeModal($el) {
    $el.classList.remove("is-active");
  }

  async function setParams() {
    let data = await fetch(`http://${url}/params`).then((res) => res.json());
    if (data["status"] != "success") return;
    data = data["msg"];
    const rawData = Object.keys(data)
      .map((key) => {
        return {
          id: key,
          group: key.split("_")[0],
          name: key,
          help: data[key].help[0],
          _help: data[key].help,
          default: data[key].default,
          value: data[key].value,
        };
      })
      .sort((a, b) => a.name.localeCompare(b.name));
    // 状态
    let searchKeyword = "";
    let expandedGroups = new Set();
    let selectedGroup = null; // string
    let selectedItemId = null; // number

    // 过滤后的数据
    function getFilteredData() {
      if (!searchKeyword) return rawData;
      const kw = searchKeyword.trim().toLowerCase();
      return rawData.filter(
        (item) =>
          item.group.toLowerCase().includes(kw) ||
          item.name.toLowerCase().includes(kw) ||
          item.help.toLowerCase().includes(kw)
      );
    }

    // 分组
    function groupData(data) {
      const groups = {};
      data.forEach((item) => {
        if (!groups[item.group]) groups[item.group] = [];
        groups[item.group].push(item);
      });
      return groups;
    }

    // 渲染左侧分组列表
    function renderSidebar() {
      const sidebar = document.getElementById("sidebar");
      sidebar.innerHTML = "";
      const data = getFilteredData();
      const groups = groupData(data);

      Object.entries(groups).forEach(([group, items]) => {
        // 一级分组
        const groupDiv = document.createElement("div");

        const groupTitle = document.createElement("div");
        groupTitle.className =
          "group-title" +
          (expandedGroups.has(group) ? "" : " collapsed") +
          (selectedGroup === group && !selectedItemId ? " selected" : "");
        groupTitle.innerHTML = `
          <span class="icon">
            <svg style="transform: scale(0.7);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M201.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 338.7 54.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"/></svg>
          </span>
          ${group}
        `;
        groupTitle.addEventListener("click", (e) => {
          e.stopPropagation();
          // 切换展开
          if (expandedGroups.has(group)) {
            expandedGroups.delete(group);
          } else {
            expandedGroups.add(group);
          }
          // 选中一级
          selectedGroup = group;
          selectedItemId = null;
          renderSidebar();
          updateTableData();
        });
        groupDiv.appendChild(groupTitle);

        // 二级条目
        if (expandedGroups.has(group)) {
          items.forEach((item) => {
            //console.log(item);
            const itemDiv = document.createElement("div");
            itemDiv.className =
              "list-item" + (selectedItemId === item.id ? " selected" : "");
            itemDiv.textContent = item.name;
            itemDiv.title = `${item.name}`;
            itemDiv.addEventListener("click", (e) => {
              e.stopPropagation();
              selectedGroup = group;
              selectedItemId = item.id;
              renderSidebar();
              updateTableData();
            });
            groupDiv.appendChild(itemDiv);
          });
        }
        sidebar.appendChild(groupDiv);
      });

      // “全部”按钮
      const allBtn = document.createElement("div");
      allBtn.className =
        "group-title" +
        (!selectedGroup && !selectedItemId ? " selected" : "");
      allBtn.innerHTML = `<span class="icon" style="opacity:0; transform: scale(0.7);">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M201.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 338.7 54.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"/></svg>
        </span>全部`;
      allBtn.addEventListener("click", () => {
        selectedGroup = null;
        selectedItemId = null;
        renderSidebar();
        updateTableData();
      });
      sidebar.insertBefore(allBtn, sidebar.firstChild);
    }

    // 获取当前表格要显示的数据
    function getCurrentTableData() {
      const data = getFilteredData();
      if (!selectedGroup && !selectedItemId) {
        return data;
      } else if (selectedGroup && !selectedItemId) {
        return data.filter((item) => item.group === selectedGroup);
      } else if (selectedGroup && selectedItemId) {
        return data.filter((item) => item.id === selectedItemId);
      }
      return data;
    }

    const updateData = {};
    // 渲染表格
    var clusterize = new Clusterize({
      scrollId: "scrollArea",
      contentId: "contentArea",
    });

    function updateTableData() {
      let tableData = getCurrentTableData();
      tableData = tableData.map((item) => {
        return `<tr>
          <td>${item.name}</td>
          <td class="help-cell" title="${item._help.join("\n")}">${item.help
          }</td>
          <td>${item.default}</td>
          <td class="editable-cell col3" data-id="${item.id}">${item.value}</td>
        </tr>`;
      });
      clusterize && clusterize.update(tableData);
      // 可编辑
      const area = document.querySelector("#contentArea");
      area.addEventListener("click", (e) => {
        const cell = e.target.closest(".editable-cell");
        if (!cell) return;
        if (cell.querySelector("input")) return; // 已经在编辑
        const id = cell.dataset.id;
        const input = document.createElement("input");
        input.type = "text";
        input.value = cell.innerText;
        cell.innerHTML = "";
        cell.appendChild(input);
        input.focus();
        input.select();

        const updateDone = () => {
          cell.innerHTML = input.value;
          updateData[id] = input.value;
        };

        input.addEventListener("blur", updateDone);
        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            input.blur();
          } else if (e.key === "Escape") {
            updateDone();
          }
        });
      });
      return tableData;
    }

    // 搜索框
    const search = document.getElementById("searchInput");

    search.addEventListener("input", function () {
      searchKeyword = this.value;
      // 清除选择
      selectedGroup = null;
      selectedItemId = null;
      renderSidebar();
      updateTableData();
    });
    search.value = "";

    // 初始化
    renderSidebar();
    setTimeout(updateTableData, 0);

    let dialog = document.getElementById("tableDialog");
    document
      .getElementById("tableCancelBtn")
      .addEventListener("click", (e) => {
        e.preventDefault(); // 阻止表单默认提交
        closeModal(dialog);
      });
    document
      .getElementById("tableConfirmBtn")
      .addEventListener("click", (e) => {
        e.preventDefault(); // 阻止表单默认提交
        Object.entries(updateData).forEach(([name, value]) => {
          postJson('/set_param', { name, value })
            .then(res => res.json())
            .then(resJSON => console.log(resJSON))
            .catch(err => console.log(err))
        });
        closeModal(dialog);
      });
    openModal(dialog);
  }
</script>

</html>